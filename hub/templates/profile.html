<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ .title }} - Qube Hub</title>
  <link rel="stylesheet" href="/static/css/style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <nav class="navbar">
    <div class="container">
      <a href="/" class="nav-brand" style="text-decoration: none; display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <img src="/static/logo.png" alt="Qube Logo" width="28" height="28">
        <span>QubeCloud</span>
      </a>
      <button class="nav-toggle" id="navToggle" aria-label="Toggle navigation">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <div class="nav-menu">
        <a href="/" class="nav-link">Home</a>
        <a href="/explore" class="nav-link">Explore</a>
        <div class="nav-auth" id="navAuth">
          <a href="/login" class="nav-link">Login</a>
          <a href="/signup" class="btn-primary">Get Started</a>
        </div>
        <div class="nav-user" id="navUser" style="display: none;">
          <button id="uploadBtn" class="btn-primary-sm">+ Upload</button>
          <div class="user-profile-menu">
            <button id="profileMenuBtn" class="profile-btn">
              <img id="navAvatar" src="/static/img/avatar-default.svg" alt="Avatar" width="24" height="24" style="border-radius:50%" onerror="this.src='/static/img/avatar-default.svg'" />
            </button>
            <div class="profile-dropdown" id="profileDropdown">
              <div class="profile-info">
                <p id="profileUsername" class="profile-name">User</p>
                <p id="profileEmail" class="profile-email">user@example.com</p>
              </div>
              <hr>
              <a href="/profile" class="dropdown-item">My Images</a>
              <a href="/settings" class="dropdown-item">Settings</a>
              <hr>
              <a href="#" id="logoutBtn" class="dropdown-item danger">Logout</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <div class="container">
    <h1>My Images</h1>
    <div class="table-responsive">
      <table class="images-table" id="myImagesTable">
        <thead>
          <tr>
            <th>Logo</th>
            <th>Name</th>
            <th>Tags</th>
            <th>Updated</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="myImages"></tbody>
      </table>
    </div>
    <div class="pager">
      <button id="prevBtn" class="btn">Prev</button>
      <span id="pageInfo"></span>
      <button id="nextBtn" class="btn">Next</button>
    </div>
    <div class="section-header">
      <div>
        <p class="section-subtitle">Your uploaded images with tags and last updates.</p>
      </div>
    </div>
  </div>

  <div id="deleteModal" class="modal">
    <div class="modal-content delete-modal">
      <div class="modal-header">
        <h2>Delete Images</h2>
        <button class="close">&times;</button>
      </div>
      <p>What would you like to delete?</p>
      
      <div class="form-group" id="versionSelectorGroup" style="display: none;">
        <label for="versionSelector">Select Version:</label>
        <select id="versionSelector" class="form-control">
          <option value="">Select a version...</option>
        </select>
      </div>
      
      <div class="modal-buttons">
        <button id="deleteSpecificBtn" class="btn-primary">Delete This Version</button>
        <button id="deleteAllBtn" class="btn-secondary danger">Delete All Versions</button>
        <button id="cancelDeleteBtn" class="btn-secondary">Cancel</button>
      </div>
    </div>
  </div>

  <style>
    .delete-modal {
      max-width: 400px;
      width: 90%;
    }
    
    .delete-modal p {
      margin-bottom: 25px;
      color: var(--text-secondary);
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-primary);
      font-weight: 500;
      font-size: 14px;
    }
    
    .form-control {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 14px;
      cursor: pointer;
    }
    
    .form-control:hover {
      border-color: var(--border-hover);
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
    }
    
    .modal-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .modal-buttons button {
      padding: 12px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }
  </style>

<script>
(function(){
  const token = localStorage.getItem('token');
  let offset = 0; const limit = 20; let total = 0;
  let currentDeleteImageId = null;
  let currentDeleteImageName = null;
  let currentDeleteImageTag = null;
  let allImages = [];

  const modal = document.getElementById('deleteModal');
  const closeBtn = document.querySelector('.close');
  const deleteSpecificBtn = document.getElementById('deleteSpecificBtn');
  const deleteAllBtn = document.getElementById('deleteAllBtn');
  const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
  const versionSelector = document.getElementById('versionSelector');
  const versionSelectorGroup = document.getElementById('versionSelectorGroup');

  closeBtn.addEventListener('click', () => { modal.classList.remove('open'); });
  window.addEventListener('click', (e) => { if (e.target === modal) modal.classList.remove('open'); });
  
  cancelDeleteBtn.addEventListener('click', () => { modal.classList.remove('open'); });

  versionSelector.addEventListener('change', () => {
    deleteSpecificBtn.disabled = !versionSelector.value;
  });

  deleteSpecificBtn.addEventListener('click', async () => {
    if (!versionSelector.value) return;
    const selectedImageId = versionSelector.value;
    const res = await fetch(`/api/images/${selectedImageId}`, { 
      method: 'DELETE', 
      headers: { Authorization: `Bearer ${token}` }
    });
    if (res.ok) { 
      showToast('Version deleted'); 
      load(); 
    } else { 
      const j = await res.json().catch(()=>({})); 
      showToast(j.error||'Delete failed'); 
    }
    modal.classList.remove('open');
    versionSelector.value = '';
    currentDeleteImageId = null;
  });

  deleteAllBtn.addEventListener('click', async () => {
    if (!confirm('Are you sure? This will delete ALL versions of this image.')) return;
    const imagesToDelete = allImages.filter(img => img.name === currentDeleteImageName);
    let successCount = 0;
    for (const img of imagesToDelete) {
      const res = await fetch(`/api/images/${img.id}`, { 
        method: 'DELETE', 
        headers: { Authorization: `Bearer ${token}` }
      });
      if (res.ok) successCount++;
    }
    if (successCount > 0) {
      showToast(`${successCount} version(s) deleted`); 
      load(); 
    } else {
      showToast('Delete failed'); 
    }
    modal.classList.remove('open');
  });
  
  async function load(){
    const res = await fetch(`/api/images/my?limit=1000&offset=0`, { headers: { Authorization: `Bearer ${token}` }});
    const data = await res.json();
    allImages = data.images || [];
    
    // Deduplicate: keep only one image per name (ignore tags)
    const imageMap = new Map();
    allImages.forEach(img => {
      const existing = imageMap.get(img.name);
      if (!existing || new Date(img.last_updated) > new Date(existing.last_updated)) {
        imageMap.set(img.name, img);
      }
    });
    
    const uniqueImages = Array.from(imageMap.values());
    total = uniqueImages.length;
    
    const startIdx = offset;
    const endIdx = Math.min(offset + limit, total);
    const paginatedImages = uniqueImages.slice(startIdx, endIdx);
    
    document.getElementById('pageInfo').textContent = `${startIdx+1}-${endIdx} of ${total}`;
    const tbody = document.getElementById('myImages');
    tbody.innerHTML = '';
    paginatedImages.forEach(img => {
      const tr = document.createElement('tr');
      const primaryTag = (img.tag||'').split(',')[0];
      const tagsHtml = (img.tag||'').split(',').filter(Boolean).map(t=>`<span class='tag'>${t.trim()}</span>`).join('');
      tr.innerHTML = `
        <td><div class='thumb sm'><img src='${img.logo_path||'/static/img/placeholder.svg'}' onerror="this.src='/static/img/placeholder.svg'" /></div></td>
        <td><a href="/images/${img.name}/${primaryTag}" class="title">${img.name}</a></td>
        <td><div class="tags">${tagsHtml}</div></td>
        <td>${new Date(img.last_updated).toLocaleString()}</td>
        <td>
          <div class="btn-group">
            <button class="btn-sm" data-act="edit">Edit</button>
            <button class="btn-sm danger" data-act="delete">Delete</button>
            <button class="btn-sm" data-act="toggle">${img.is_public ? 'Make Private' : 'Make Public'}</button>
          </div>
        </td>`;
      tr.querySelector('[data-act=edit]').addEventListener('click', ()=>{
        window.location.href = `/images/${img.name}/${primaryTag}`;
      });
      tr.querySelector('[data-act=delete]').addEventListener('click', ()=>{
        currentDeleteImageId = img.id;
        currentDeleteImageName = img.name;
        currentDeleteImageTag = primaryTag;
        
        // Get all versions of this image
        const versions = allImages.filter(i => i.name === img.name);
        versionSelector.innerHTML = '<option value="">Select a version...</option>';
        versions.forEach(v => {
          const tag = (v.tag||'').split(',')[0] || 'unknown';
          const option = document.createElement('option');
          option.value = v.id;
          option.textContent = `${tag} (${new Date(v.last_updated).toLocaleDateString()})`;
          versionSelector.appendChild(option);
        });
        
        if (versions.length > 1) {
          versionSelectorGroup.style.display = 'block';
          deleteSpecificBtn.disabled = true;
        } else {
          versionSelectorGroup.style.display = 'none';
          if (versions.length > 0) {
            versionSelector.value = versions[0].id;
            deleteSpecificBtn.disabled = false;
          }
        }
        
        deleteAllBtn.style.display = versions.length > 1 ? 'block' : 'none';
        
        modal.classList.add('open');
      });
      tr.querySelector('[data-act=toggle]').addEventListener('click', async ()=>{
        const fd = new FormData();
        fd.append('is_public', (!img.is_public).toString());
        const res = await fetch(`/api/images/by-name/${encodeURIComponent(img.name)}/${encodeURIComponent(primaryTag)}`, { method: 'POST', headers: { Authorization: `Bearer ${token}` }, body: fd });
        if (res.ok) { showToast('Visibility updated'); load(); } else { const j = await res.json().catch(()=>({})); showToast(j.error||'Update failed'); }
      });
      tbody.appendChild(tr);
    });
    document.getElementById('prevBtn').disabled = offset<=0;
    document.getElementById('nextBtn').disabled = offset+limit>=total;
  }
  document.getElementById('prevBtn').addEventListener('click', ()=>{ offset = Math.max(0, offset - limit); load(); });
  document.getElementById('nextBtn').addEventListener('click', ()=>{ offset = Math.min(total, offset + limit); load(); });
  const toast = document.createElement('div'); toast.className = 'toast'; document.body.appendChild(toast);
  window.showToast = (msg)=>{ toast.textContent = msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 2000); };
  load();
})();
</script>
<script>
(async function(){
    try {
        const token = localStorage.getItem('token');
        if (!token) return;
        const res = await fetch('/api/auth/profile', { headers: { Authorization: `Bearer ${token}` }});
        if (!res.ok) return;
        const u = await res.json();
        const avatar = document.getElementById('navAvatar');
        if (u.id) { avatar.src = `/static/avatars/${u.id}.png`; }
        document.getElementById('profileUsername').textContent = u.username || 'User';
        document.getElementById('profileEmail').textContent = u.email || '';
    } catch {}
})();
</script>
<script src="/static/js/app.js"></script>
</body>
</html>
